/**
 * WhereNow plugin.
 *
 * Used to determine if the user is within a specific time and place (if possible).
 *
 * @author Kalley Powell (kalley.powell AT gmail.com)
 *
 */
(function(i,x){var n=x.navigator;i.whereNow=function(b,d,a,f){return j.instance(b,d,a,f)};var l=null,m=null,h=function(b){return b*(Math.PI/180)},q=function(b,d){var a=h(b.lat-d.latitude),f=h(b.lng-d.longitude);a=Math.sin(a/2)*Math.sin(a/2)+Math.cos(h(b.lat))*Math.cos(h(d.latitude))*Math.sin(h(f)/2)*Math.sin(h(f)/2);return 6371*2*Math.atan(Math.sqrt(a),Math.sqrt(1-a))},j=function(b,d){var a=this,f=false,e=i.extend({},this.defaults,d),r=new Date;this.locations=b;
this.oldTimeIndex=this.timeIndex=this.oldLocIndex=this.locIndex=-1;this.withinRadius=this.changed=false;(function s(){a.locOldIndex=a.locIndex;a.oldTimeIndex=a.timeIndex;a.changed=false;var y=function(k){for(var g,o,t=e.success,u=new Date,c=0,p=a.locations.length;c<p;c++){var v=q(a.locations[c],k.coords);if(!o||v<o){o=v;a.locIndex=c;g=a.locations[c]}}a.withinRadius=e.radius*1.609344>q(g,k.coords);if(a.withinRadius){if(g.success)t=g.success;c=0;for(p=g.times.length;c<p;c++)if(g.times[c].start<u&&(!g.times[c].end||
u<g.times[c].end))a.timeIndex=c;else break}else a.timeIndex=-1;if(a.timeIndex!=a.oldTimeIndex||a.locIndex!=a.oldLocIndex)a.changed=true;t(a,g);e.complete(a);if(!e.stopAt||r<e.stopAt)m=setTimeout(s,e.delay)},w=function(k){if(k.code==1)f=true;e.error(k,a);e.complete(a);if(!e.stopAt||r<e.stopAt)m=setTimeout(s,e.delay)};f||n.geolocation?n.geolocation.getCurrentPosition(y,w):w(f?{code:1,message:"The method failed to retrieve the location of the device because the application does not have permission to use the Location Service."}:
{code:4,message:"Geolocation not available."})})()};i.whereNow.defaults=j.prototype.defaults={radius:0.25,delay:3E3,api:null,stopAt:null,complete:function(){},success:function(){},error:function(){}};i.whereNow.todayAt=j.prototype.todayAt=function(){for(var b=new Date,d=["Hours","Minutes","Seconds","Milliseconds"],a=0,f=arguments.length;a<f;a++)b["set"+d[a]](arguments[a]);return b};j.instance=function(b,d,a){if(l===null||a){clearTimeout(m);l=m=null;l=new j(b,d)}return l}})(jQuery,window);