/**
 * WhereNow plugin.
 *
 * Used to determine if the user is within a specific time and place (if possible).
 *
 * @author Kalley Powell (kalley.powell AT gmail.com)
 *
 */
(function(l,y){var r=y.navigator;l.whereNow=function(b,e,a,f){return i.instance(b,e,a,f)};var m=null,n=null,h=function(b){return b*(Math.PI/180)},s=function(b,e){var a=h(b.lat-e.latitude),f=h(b.lng-e.longitude);a=Math.sin(a/2)*Math.sin(a/2)+Math.cos(h(b.lat))*Math.cos(h(e.latitude))*Math.sin(h(f)/2)*Math.sin(h(f)/2);return 6371*2*Math.atan(Math.sqrt(a),Math.sqrt(1-a))},i=function(b,e){var a=this,f=false,c=l.extend({},this.defaults,e),t=new Date;this.locations=b;this.oldTimeIndex=this.timeIndex=this.oldLocIndex=
this.locIndex=-1;this.withinRadius=this.changed=false;this.options=function(j,o){if(o)c[j]=o;return c[j]};(function j(){a.locOldIndex=a.locIndex;a.oldTimeIndex=a.timeIndex;a.changed=false;var o=function(k){for(var g,p,u=c.success,v=new Date,d=0,q=a.locations.length;d<q;d++){var w=s(a.locations[d],k.coords);if(!p||w<p){p=w;a.locIndex=d;g=a.locations[d]}}a.withinRadius=c.radius*1.609344>s(g,k.coords);if(a.withinRadius){if(g.success)u=g.success;d=0;for(q=g.times.length;d<q;d++)if(g.times[d].start<v&&
(!g.times[d].end||v<g.times[d].end))a.timeIndex=d;else break}else a.timeIndex=-1;if(a.timeIndex!=a.oldTimeIndex||a.locIndex!=a.oldLocIndex)a.changed=true;u(a,g);c.complete(a);if(!c.stopAt||t<c.stopAt)n=setTimeout(j,c.delay)},x=function(k){if(k.code==1)f=true;c.error(k,a);c.complete(a);if(!c.stopAt||t<c.stopAt)n=setTimeout(j,c.delay)};f||r.geolocation?r.geolocation.getCurrentPosition(o,x):x(f?{code:1,message:"The method failed to retrieve the location of the device because the application does not have permission to use the Location Service."}:
{code:4,message:"Geolocation not available."})})()};l.whereNow.defaults=i.prototype.defaults={radius:0.25,delay:3E3,api:null,stopAt:null,complete:function(){},success:function(){},error:function(){}};l.whereNow.todayAt=i.prototype.todayAt=function(){for(var b=new Date,e=["Hours","Minutes","Seconds","Milliseconds"],a=0,f=arguments.length;a<f;a++)b["set"+e[a]](arguments[a]);return b};i.instance=function(b,e,a){if(m===null||a){clearTimeout(n);m=n=null;m=new i(b,e)}return m}})(jQuery,window);