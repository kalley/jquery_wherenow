/**
 * WhereNow plugin.
 *
 * Used to determine if the user is within a specific time and place (if possible).
 *
 * @author Kalley Powell (kalley.powell AT gmail.com)
 *
 */
(function(m,w){var s=w.navigator;m.whereNow=function(b,e,a,g){return k.instance(b,e,a,g)};var n=null,o=null,i=function(b){return b*(Math.PI/180)},t=function(b,e){var a=i(b.lat-e.latitude),g=i(b.lng-e.longitude);a=Math.sin(a/2)*Math.sin(a/2)+Math.cos(i(b.lat))*Math.cos(i(e.latitude))*Math.sin(i(g)/2)*Math.sin(i(g)/2);return 6371*2*Math.atan(Math.sqrt(a),Math.sqrt(1-a))},k=function(b,e){var a=this,g=false,c=m.extend({},a.defaults,e);a.locations=b;a.locIndex=-1;a.oldLocIndex=-1;a.timeIndex=-1;a.oldTimeIndex=
-1;a.changed=false;a.withinRadius=false;a.options=function(l,h){if(h)c[l]=h;return c[l]};(function l(){a.oldLocIndex=a.locIndex;a.oldTimeIndex=a.timeIndex;a.timeIndex=-1;a.changed=false;var h=new Date,x=function(j){for(var f,p,q=c.success,d=0,r=a.locations.length;d<r;d++){var u=t(a.locations[d],j.coords);if(!p||u<p){p=u;a.locIndex=d;f=a.locations[d]}}a.withinRadius=c.radius*1.609344>t(f,j.coords);if(a.withinRadius){if(f.success)q=f.success;d=0;for(r=f.times.length;d<r;d++)if(f.times[d].start<h&&(!f.times[d].end||
h<f.times[d].end))a.timeIndex=d;else break}if(a.timeIndex!=-1&&f.times[a.timeIndex].success)q=f.times[a.timeIndex].success;if(a.timeIndex!=a.oldTimeIndex||a.locIndex!=a.oldLocIndex)a.changed=true;q(a,f,j.coords);c.complete(a);if(!c.stopAt||h<c.stopAt)o=setTimeout(l,c.delay)},v=function(j){if(j.code==1)g=true;c.error(j,a);c.complete(a);if(!c.stopAt||h<c.stopAt)o=setTimeout(l,c.delay)};g||s.geolocation?s.geolocation.getCurrentPosition(x,v):v(g?{code:1,message:"The method failed to retrieve the location of the device because the application does not have permission to use the Location Service."}:
{code:4,message:"Geolocation not available."})})()};m.whereNow.defaults=k.prototype.defaults={radius:0.25,delay:3E3,api:null,stopAt:null,complete:function(){},success:function(){},error:function(){}};m.whereNow.todayAt=k.prototype.todayAt=function(){for(var b=new Date,e=["Hours","Minutes","Seconds","Milliseconds"],a=0,g=arguments.length;a<g;a++)b["set"+e[a]](arguments[a]);return b};k.instance=function(b,e,a){if(n===null||a){clearTimeout(o);n=o=null;n=new k(b,e)}return n}})(jQuery,window);